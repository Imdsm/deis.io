---
layout: post
title: Deploying Django on Deis
author: bacongobbler
meta:
  - name: description
    content: Demonstrates application deployment best practices with Deis
  - name: keywords
    content: deis, v0.9.1, django, south, heroku, buildpacks, dockerfile
---

Today, I will be showing you how to deploy a Django application on Deis. We'll be touching
on topics like

 - backing services (postgres)
 - handling database migrations
 - filesystem ephemerality
 - Heroku Buildpacks
 - Docker's build system
 - Application Release Management

If you want to follow along, you can clone [the django-polls project][example-app] that
was generated by following the steps in the
["Writing your first Django app"][django-app-docs] tutorial in the official documentation.
Of course, we made a few changes to the project to follow [12 factor][12-factor] best
practices and methodologies, as well as add some new features to the application like
database migrations. We'll be talking about those changes in this post so you can better
understand what makes an application Deis-ready.

## Heroku Buildpacks

For the first step, Heroku came out with a concept called [Heroku Buildpacks][buildpacks].
Buildpacks are packages that describe and fetch the dependencies required for a specific
application framework or type. For example, most 12 factor Python applications now
describe their external dependencies in a `requirements.txt` file.

## Dockerfiles

There's a reason why we call ourselves a Docker-based PaaS. Our builder allows you to
deploy your application using [Dockerfiles][dockerfile], which is a file that describes
the steps required to create a Docker image.

## Deploying to Deis

If you'd like to follow through this blog post, you can do so by running the following:

    $ cd django-polls
    $ # check out an older version of the app
    $ git checkout b8d8f107ddf925aa110bf7a41130956dc2de047f
    $ deis create
    $ git push deis master

Once the build is complete, you should have the application running on Deis, and you
should have a URL that you can access to view your application. However, we have one thing
that is "wrong" set up with this application... we are running our database with sqlite.
This is bad on the 12 factor side of things for a few reasons...

1) Containers are considered ephemeral. Think of it like a scratchpad. Once the
application dies or is recycled, the scratchpad's top page is ripped off and a fresh new
page takes its place. Since sqlite is a file-based database, your data is also ephemeral.

2) Each instance will have its own sqlite database that it will be writing to, which means
that your data is not shared between instances.

12 factor methodology solves this problem through the use of environment variables set at
runtime for backing services. For this app, you can set a environment variable through
Deis:

    $ deis config:set DATABASE_URL=postgres://...

After that, a new release of your app will be deployed with the new environment variable
embedded into the container. Our Dockerfile does not run the database migration instantly.
However, we can run it with the `deis run` command. Let's sync our database and run our
first migration:

    $ deis run python manage.py syncdb --noinput
    $ deis run python manage.py migrate --noinput

### Handling Database Migrations

Now that our app is deployed, we need some way to deploy new releases of our application
and then migrate the database over to the new release. With Deis, this is a really
painless problem. To do this with the Django app, let's fast forward to a later revision
that requires the migration and push the app:

    $ git checkout master
    $ git push deis master
    $ deis run python manage.py migrate polls --noinput

If we don't like the migration, we can simply perform a rollback:

    $ deis run python manage.py migrate 0001_initial

And if we don't like the new version of the app at all, we can roll back to a previous
release:

    $ deis rollback v2

I hope this post brought some insight on how some best practices for deploying apps to
Deis. Now get out there and start crackin'!


[confd]: https://github.com/kelseyhightower/confd
[dockerfile]: http://docs.deis.io/en/latest/using_deis/using-dockerfiles/
[etcd]: https://github.com/coreos/etcd
[example-app]: https://github.com/deis/django-polls
[django-app-docs]: https://docs.djangoproject.com/en/1.6/intro/tutorial01/
[12-factor]: http://12factor.net/
